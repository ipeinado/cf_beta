<% provide(:title, I18n.t(:find_out)) %>

<div class="row" id="discover">
  <div class="col-md-8">
    <h1><%= t(:find_out) %></h1>
    <ul class="projects">
      <% @projects.each do |project| %>
        <%= render project %>
      <% end %>
    </ul>
  </div>
  <div class="col-md-4">
    <div id="map" data-longitude="<%= @client_coordinates[0] %>" data-latitude="<%= @client_coordinates[1] %>"></div>
  </div>
</div>

<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.js'></script>
<%= javascript_tag do %>
  $(document).ready(function() {

    var map,
          longitude = $('#map').data('longitude'),
          latitude = $('#map').data('latitude');
    var zoom = (longitude == 37.741) ? 2 : 9;

    L.mapbox.accessToken = 'pk.eyJ1IjoibmFjaG9wZSIsImEiOiI1NWU1NTU4ZWMwZDY0N2EzMzNjOWRmMzI0OWNkZWFmNiJ9.vJEDvTiigh5rONaLVEeOdQ';

    map = L.mapbox.map('map', 'nachope.a61a77e9').setView([longitude, latitude], zoom);
    map.scrollWheelZoom.disable();

    $.ajax({
      dataType: 'text',
      url: 'descubre.json',
      success: function(data) {
        var geojson;
        geojson = $.parseJSON(data);
        map.featureLayer.setGeoJSON(geojson);
      }
    });

    map.featureLayer.on('layeradd', function(e) {
      var marker, popupContent, properties;
      marker = e.layer;
      properties = marker.feature.properties;
      popupContent = '<div class="project-popup popup">';
      if (properties.logo !== "") {
        popupContent += '<div class="project-popup-logo"><img src="' + properties.logo + '"></div>';
      }
      popupContent += '<div class="project-popup-content">' + '<h3>' + properties.name + '</h3>' + '<p>' + properties.description + '</p></div>';
      if (properties.featured_picture !== "") {
        popupContent += '<div class="project-popup-project-link"><a href="/projects/' + properties.project_id + '" class="btn btn-warning">Ir al proyecto</a></div>' + '<div class="project-popup-featured-picture"><img src="' + properties.featured_picture + '" /></div>';
      } else {
        popupContent += '<p class="project-popup-p-link"><a href="' + properties.website + '" target="_blank" class="btn btn-warning" style="color: #FFF;">Ir al proyecto</a></p>';
      }
      popupContent = popupContent + "</div>";

      marker.bindPopup(popupContent, {
        closeButton: true,
        minWidth: 320
      });

      marker.onclick = function() {
        alert("hello");
      }
    });

  });
<% end %>
